<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div class="space-x-4">
        <button onclick="openModal('modalParticipation')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition-all active:scale-95">
            Participation
        </button>
        <button onclick="openModal('modalMaster')" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg transition-all active:scale-95">
            Room Master
        </button>
    </div>

    <div id="modalParticipation" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-blue-600 border-b pb-2">Join Challenge</h2>
            <div class="space-y-3">
                <input type="text" id="partName" placeholder="Nama Anda" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="joinRoomId" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Room ID (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="joinPw" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Password (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('modalParticipation')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">Batal</button>
                <button onclick="handleJoin()" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700">Masuk</button>
            </div>
        </div>
    </div>

    <div id="modalMaster" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-green-600 border-b pb-2">Create New Room</h2>
            <div class="space-y-3">
                <input type="text" id="masterName" placeholder="Nama Master" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
                <input type="text" id="createRoomId" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Buat Room ID (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="createPw" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Buat Password (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('modalMaster')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">Batal</button>
                <button onclick="handleCreate()" class="bg-green-600 text-white px-6 py-2 rounded font-semibold hover:bg-green-700">Buat Room</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://bmswsgtgxmijjomkltzx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtc3dzZ3RneG1pampvbWtsdHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTc5MDIsImV4cCI6MjA4NTg3MzkwMn0.tudVaH1BpfQA2h6EhWv2ekmhAPMTgDhiEKRbvCOM074';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Fungsi Validasi Khusus Angka 4-6 Digit
        function isValidCode(code) {
            const regex = /^[0-9]{4,6}$/; // Hanya angka, panjang 4 sampai 6
            return regex.test(code);
        }

        async function handleCreate() {
    const name = document.getElementById('masterName').value.trim();
    const roomId = document.getElementById('createRoomId').value.trim();
    const pw = document.getElementById('createPw').value.trim();

    if(!name || !roomId || !pw) return alert("Harap isi semua kolom!");
    if(!isValidCode(roomId) || !isValidCode(pw)) {
        return alert("Room ID dan Password harus berupa angka (4 - 6 digit)!");
    }

    // 1. CEK: Apakah Room ID sudah ada?
    const { data: existingRoom, error: checkError } = await db
        .from('rooms')
        .select('*')
        .eq('room_id', roomId)
        .maybeSingle(); // Menggunakan maybeSingle agar tidak error jika data nol

    if (existingRoom) {
        // 2. Jika ada, cek apakah passwordnya cocok?
        if (existingRoom.password === pw) {
            alert("Masuk kembali ke room yang sudah ada.");
            lanjutKeWaitingRoom('master', roomId, name);
        } else {
            alert("Room ID sudah digunakan dengan password berbeda!");
        }
    } else {
        // 3. Jika benar-benar belum ada, baru buat database baru
        const { error: insertError } = await db
            .from('rooms')
            .insert([{ room_id: roomId, password: pw, master_name: name }]);
        
        if (!insertError) {
            lanjutKeWaitingRoom('master', roomId, name);
        } else { 
            alert("Gagal membuat room: " + insertError.message); 
        }
    }
}

async function handleJoin() {
    const name = document.getElementById('partName').value.trim();
    const roomId = document.getElementById('joinRoomId').value.trim();
    const pw = document.getElementById('joinPw').value.trim();

    // 1. Validasi Input Dasar
    if(!name || !roomId || !pw) return alert("Harap isi semua kolom!");
    if(!isValidCode(roomId) || !isValidCode(pw)) {
        return alert("Room ID dan Password harus berupa angka (4 - 6 digit)!");
    }

    // 2. VALIDASI ROOM & PASSWORD (TOLAK JIKA TIDAK COCOK)
    const { data: roomData, error: roomError } = await db
        .from('rooms')
        .select('room_id, password')
        .eq('room_id', roomId)
        .eq('password', pw) // Password langsung dicek di sini
        .maybeSingle();

    if (!roomData) {
        // Jika Room tidak ketemu ATAU Password salah, akses ditolak
        return alert("AKSES DITOLAK: Room ID atau Password salah!");
    }

    // 3. CEK APAKAH PESERTA SUDAH TERDAFTAR (UNTUK RE-ENTRY)
    const { data: existingPart, error: partCheckError } = await db
        .from('participants')
        .select('*')
        .eq('room_id', roomId)
        .eq('student_name', name)
        .maybeSingle();

    if (existingPart) {
        // Jika nama + room_id sudah ada, anggap sebagai login ulang
        console.log("Nama sudah terdaftar di room ini, masuk sebagai user lama...");
        lanjutKeWaitingRoom('participant', roomId, name);
    } else {
        // 4. DAFTARKAN PESERTA BARU
        const { error: partInsertError } = await db
            .from('participants')
            .insert([{ room_id: roomId, student_name: name }]);

        if (!partInsertError) {
            lanjutKeWaitingRoom('participant', roomId, name);
        } else {
            alert("Gagal mendaftar: " + partInsertError.message);
        }
    }
}

// Fungsi pembantu agar kode lebih rapi
function lanjutKeWaitingRoom(role, roomId, username) {
    localStorage.setItem('role', role);
    localStorage.setItem('room_id', roomId);
    localStorage.setItem('username', username);
    window.location.href = 'challengestart.html';
}
    </script>
</body>
</html>
