<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

    <div class="space-x-4">
        <button onclick="openModal('modalParticipation')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition-all active:scale-95">
            Participation
        </button>
        <button onclick="openModal('modalMaster')" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg transition-all active:scale-95">
            Room Master
        </button>
    </div>

    <div id="modalParticipation" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-blue-600 border-b pb-2">Join Challenge</h2>
            <div class="space-y-3">
                <input type="text" id="partName" placeholder="Nama Anda" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="joinRoomId" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Room ID (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="joinPw" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Password (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('modalParticipation')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">Batal</button>
                <button onclick="handleJoin()" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700">Masuk</button>
            </div>
        </div>
    </div>

    <div id="modalMaster" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-green-600 border-b pb-2">Create New Room</h2>
            <div class="space-y-3">
                <input type="text" id="masterName" placeholder="Nama Master" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
                <input type="text" id="createRoomId" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Buat Room ID (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="createPw" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="Buat Password (4-6 Angka)" class="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div class="flex justify-end mt-6 space-x-2">
                <button onclick="closeModal('modalMaster')" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">Batal</button>
                <button onclick="handleCreate()" class="bg-green-600 text-white px-6 py-2 rounded font-semibold hover:bg-green-700">Buat Room</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://bmswsgtgxmijjomkltzx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtc3dzZ3RneG1pampvbWtsdHp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTc5MDIsImV4cCI6MjA4NTg3MzkwMn0.tudVaH1BpfQA2h6EhWv2ekmhAPMTgDhiEKRbvCOM074';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Fungsi Validasi Khusus Angka 4-6 Digit
        function isValidCode(code) {
            const regex = /^[0-9]{4,6}$/; // Hanya angka, panjang 4 sampai 6
            return regex.test(code);
        }

        async function handleCreate() {
            const name = document.getElementById('masterName').value;
            const roomId = document.getElementById('createRoomId').value;
            const pw = document.getElementById('createPw').value;

            if(!name || !roomId || !pw) return alert("Harap isi semua kolom!");
            
            if(!isValidCode(roomId) || !isValidCode(pw)) {
                return alert("Room ID dan Password harus berupa angka (4 - 6 digit)!");
            }

            const { error } = await db.from('rooms').insert([{ room_id: roomId, password: pw, master_name: name }]);
            
            if (!error) {
                localStorage.setItem('role', 'master');
                localStorage.setItem('room_id', roomId);
                localStorage.setItem('username', name);
                window.location.href = 'challengestart.html';
            } else { alert("Gagal: " + error.message); }
        }

async function handleJoin() {
    const name = document.getElementById('partName').value.trim();
    const roomId = document.getElementById('joinRoomId').value.trim();
    const pw = document.getElementById('joinPw').value.trim();

    // 1. Validasi Input Kosong
    if(!name || !roomId || !pw) return alert("Harap isi semua kolom!");

    // 2. Validasi Format Angka (4-6 Digit)
    if(!isValidCode(roomId) || !isValidCode(pw)) {
        return alert("Room ID dan Password harus berupa angka (4 - 6 digit)!");
    }

    // 3. VALIDASI: Cek apakah Room ID dan Password cocok di tabel 'rooms'
    const { data: roomData, error: roomError } = await db
        .from('rooms')
        .select('room_id') // Kita hanya butuh konfirmasi keberadaan room
        .eq('room_id', roomId)
        .eq('password', pw)
        .single();

    if (roomError || !roomData) {
        return alert("Room ID atau Password salah!");
    }

    // 4. PENCATATAN: Tulis nama dan room_id ke tabel 'participants'
    const { error: partError } = await db
        .from('participants')
        .insert([
            { 
                room_id: roomId,      // Mencatat ID Room
                student_name: name    // Mencatat Nama Peserta
                // Kolom score tidak perlu ditulis jika sudah ada default 0 di database
            }
        ]);

    if (partError) {
        console.error("Detail Error:", partError);
        return alert("Gagal mendaftar ke room: " + partError.message);
    }

    // 5. PENYIMPANAN LOKAL & REDIRECT
    localStorage.setItem('role', 'participant');
    localStorage.setItem('room_id', roomId);
    localStorage.setItem('username', name);
    
    window.location.href = 'challengestart.html';
}
    </script>
</body>
</html>
